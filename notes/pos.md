# POS机制调研

# 0x01. POS类别

- Chain-Based:依赖网络的同步性

  算法在每个slot随机选择验证者并给与其提出区块的权利，但是该区块的产生还是以POW来进行，该区块必须指向前一个区块。需要后续使用POS来进行验证

- BFT-Based:优先考虑节点的一致性而不是可用性

  验证者被随机分配提出区块的权利，通过多轮来确定区块是否规范，每个验证者在每一轮都为某个特定的区块投票。多轮结束之后来判断给定的区块是否能成为链的一部分。区别就在于一个区块的共识可以直接达成，而不是取决于之后链的长度。



## 0x02. 51%攻击的四种类型

- 虚假确认：已经确认区块A的验证者再次确认了矛盾的区块B
- 无效确认：验证者确认了一个无效的或者不可用的区块
- 不活动：验证者不进行区块的确认
- 错误审查：验证者阻止交易或区块上链

在第一种情况下，用户可以在带外进行社交协调，以同意哪个最终区块先出现，并支持该区块。第二种情况可以通过欺诈证明和数据可用性证明来解决。第三种情况可以通过修改 PoS 算法来解决，如果不参与共识，则逐渐减少（“泄漏”）非参与节点在验证器集中的权重。第四个是最难的。第四个可以通过“少数派软分叉”恢复，少数诚实的验证者同意大多数人审查他们，并停止在链上构建。相反，他们继续自己的链(==这个自己的链应该是一个内部诚实节点的小分叉，但是肯定也不能随便构建，应该有一定的要求==)，最终上述“泄漏”机制确保这个诚实的少数人成为新链上的 2/3 绝对多数。



## 0x03. POS的危机

1. 分叉

   pos不依赖于算力，区块提出者倾向于在多个分叉上同时提交相同区块，来获得更多收益（==无利害关系==）。解决方案是通过押金限制，不允许区块提出者在两条链上同时提交。

2. 长程攻击

   参考beacon-chain.md/0x06



## 0x04. 解决无利害关系的两大策略

1. 无利害关系的定义

   提出区块的节点可能在多个分叉上同时提出相同的区块，来获得更高的奖励。但是这样会降低整个网络的效率。

2. 策略1

   涉及到对在多条链上同时出块的验证者的惩罚措施，通过将惩罚证明（即两个冲突的已签名区块头）纳入区块链，之后再适当扣除有恶意行为的验证者的保证金。

   要注意的是，要让该算法有效运行，需要提前很久确定验证者集。否则，如果一个验证者拥有1%的权益，在存在A和B两个分叉的情况下，验证者有0.99%的概率会下注在A而非B上，或是在B而非A上，验证者能够同时在两条链上下注的概率只有0.01%。因此，验证者有99%的概率会实现双重权益：可能在A上下注，也可能在B上下注，只有两种选择都开放的情况下会在更长的那条链上下注。(==这只有在两条链上的每个区块都会进行相同的验证者选择之时才能避免，这就要求在分叉产生之前选好验证者。==)(**这部分没太懂**)

   **总的来说就是避免多个分叉同时出块**

3. 策略2

   第二个策略就是惩罚在错误的链上出块的验证者。也就是说，如果有A和B两条竞争链，那么如果验证者在B链上出块，并在B链上得到＋R的奖励，但B链区块头可以包含在A链中（在Casper中这被称为“**dunkle**”），那么在A链上的验证者会遭到-F的罚金处罚（F可能等于R）。

   **总的来说就是避免在错误分叉上出块**



## 0x05. 区块回滚限制

这里要求区块在4个月之后(小于押金能取出的时间)不能够再变化，但是依然存在着可能，使得用户接收到真正区块的时间晚于接收到虚假区块的时间，从而让用户选择虚假区块。

1. 节点第一次连接到区块上
2. 节点离线4个月以上

解决方案就是用户去验证最新的链外状态，可以通过线下询问最新认真过的区块HASH，然后再进行对比。



## 0x06. 验证者审查问题

即验证者可能错误审查，例如直接抛弃一些交易，这个内容没办法进行感知。这里提出几个解决方案：

1. 宕机威胁。

   一个简单的版本是，如果验证者想要验证一个交易将来会导致的影响，或者说是否对自己有利，就需要消耗大量的计算资源，甚至会使自己宕机，以此来验证者无差别打包，而不去关注里面的内容。

   高级版本是这样设计的：用户可以同时发起多个相互影响的交易，一起在未来产生其他的影响，这一点在验证者打包时是无法感知的，等验证者感知时就已经来不及阻止了。验证者可以通过大规模阻止能证明自己有问题的交易，但是这样务必会影响整个网络，其也会因此受到惩罚。

2. 通过时间锁加密

   验证者在打包之前是不知道交易内容的，只有打包之后才会解密显示，此时就已经无法取消打包了，但是这种情况下，验证者可以只打包有某种解密版本的加密交易(eg. ZK-SNARK)，然后迫使用户去下载对于的软件，这样交易内容就会泄露。

3. 将审查机制放在分叉选择过程中

   节点会持续监视整个网络，对于拥有足够费用，但是长时间没被上链的区块链，会给以一个低分评价，最终包含这些交易的少数链会合并，然后诚实的节点会选择这条链作为主链继续follow。这样做的一个小问题就是，离线节点会再重新登陆之后会在原分叉继续工作，导致各个节点在不同链上工作。



## References

1. [POS FAQs 原文](https://eth.wiki/en/concepts/proof-of-stake-faqs)
2. [POS的类型和简单介绍](https://docs.ethhub.io/ethereum-roadmap/ethereum-2.0/proof-of-stake/)
3. [POS FAQs中文版](https://ethfans.org/posts/Proof-of-Stake-FAQ-new-2018-3-15)
4. [pos共识机制及设计哲学](https://medium.com/@tokenroll/pos%E5%85%B1%E8%AF%86%E6%9C%BA%E5%88%B6%E5%8F%8A%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6-%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E5%BC%95%E5%8D%B7%E4%B9%8B%E4%BA%94-483c4639e0f8)